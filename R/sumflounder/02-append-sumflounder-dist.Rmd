---
title: "Append summer flounder distributions"
author: "Angelia Miller"
date: "2023-07-25"
output: html_document
---

## Objective 
Script will insert external spatial predictions from sdmTMB from sseep-analysis repo into sim_distribution() and override this step of SimSurvey, thereby hardwiring distribution predictions from sdmTMB. 

Output: appended summer flounder population object from 01-simulate-sumflounder-abund.rmd with numbers at age distributed across the NEUS BTS survey grid 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(raster)
library(stars)
library(SimSurvey)
suppressPackageStartupMessages(library(tidyverse))
library(data.table)
library(patchwork)
library(here)

sdmtmb.dir <- "C:/Users/amiller7/Documents/cinar-osse/sseep-analysis/sdmtmb"

set.seed(8675309)
```


```{r data, include = FALSE}
### LOAD DATA ####
# the survey Grid as dataframe
grid_xy <- readRDS(here("data", "rds", "survey_grid_062022.rds")) |>
  rename(strat = STRATUM, 
         x = X, 
         y = Y) |>#, # rename to match column calls within SimSurvey functions
         #depth = AVGDEPTH) |>
  mutate(division = 1) |>#, # add division information
         #x = X/1000, # convert to km
         #y = Y/1000) |>
  dplyr::select(x, y, cell, division, strat, depth) |>
  data.table::as.data.table()

# the survey Grid as stars object
grid_stars <- readRDS(here("data",  "survey_grid_stars_062022.rds"))

# load spring model predictions
spring_preds <- readRDS(file = here(sdmtmb.dir, "sumflounder", "data", "spring_predictions.rds"))
#spring_preds <- readRDS(here(sdmtmb.dir, "sumflounder", "data", "spring_projects.rds"))

# load the simulated abundance
pop <- readRDS(here("R", "sumflounder", "data", "sumflounder_abundance.rds"))

# load the abundance by age
Nage <- readRDS(here("R", "sumflounder", "data", "sumflounder_Nage.rds"))

### DATA WRANGLE ####
# set coordinate system
# crs <-  "+proj=utm +zone=18 +datum=WGS84 +units=km +no_defs"

# # convert grid to raster and then stars for appending to abundance object
# grid_ras <- rasterFromXYZ(grid, crs = crs)
# grid_stars <- st_as_stars(grid_ras)
# # writeRaster(grid_ras, filename = here("data", "survey_grid_Jun2022.grd"))
```

### Distribute summer flounder numbers 

_Spatial Distribution Predictions_ 

Historical summer flounder biomass catch rate data was used to fit a spatiotemporal GLMM with the sdmTMB package. The expected biomass catch rates predicted from the model fit was extracted for the most recent 3 years of the time series. 
```{r}
# filter distribution predictions for last 3 years
preds_3yr <- spring_preds |>
  filter(EST_YEAR %in% c(2019:2021)) |>
  rename(year = EST_YEAR, #rename to match column calls in SimSurvey
         strat = STRATUM) |>
  mutate(N_dist = exp(est),
         year = case_when( # change the year values based on their sequence 
         year == 2019 ~ 1,
         year == 2020 ~ 2,
         year == 2021 ~ 3
         )) |>#,
         #cell = seq(1:length(N_dist))) |> # add cell # value 
  dplyr::select(X,Y, year, N_dist, cell, strat) |>
  data.table::as.data.table()


#plot it
ggplot(preds_3yr) +
  geom_tile(aes(X, Y, fill = N_dist), width = 10, height = 10) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  labs(x = "Longitude", y = "Latitude", fill = "Number of Summer Flounder") +
  theme_bw() +
  theme(legend.position = "bottom")

```

#### Predicted Numbers at age

Numbers at age in each cell were calculated using the sdmTMB biomass predictions as the probability of summer flounder in each cell and the numbers at age simulated from sim_abundance(). 
```{r}
dist <- sdmTMB::replicate_df(preds_3yr, "age", c(0:7)) |> # replicate the predictions over each age, so there are distributions for each age
  left_join(Nage, by = "age") |> # join populations at age to the predictions
  rename(Nage = "pop$N0",
         x = X,
         y = Y) |>
  mutate(P_i = N_dist/sum(N_dist), # probability of distribution
         N = Nage * P_i, # multiply probability by simulated numbers of age
         age = as.double(age),
         cell = as.double(cell)) |>
  dplyr::select(age, year, cell, N, x, y, strat)

dist
```

#### Forced numbers at age

Summer flounder biomass predictions in sdmTMB were constrained to the 95% cumulative distributional area observed by the historical bottom trawl survey data, which spans from Georges Bank down through the mid-Atlantic depending on the season. To simulate survey effort throughout the full NEUS grid emulating the BTS survey, numbers at age are forced as 0s in cells that were outside the sdmTMB prediction domain. 
```{r}
no_dist <- dplyr::anti_join(grid_xy, preds_3yr, by = "cell") |>
  sdmTMB::replicate_df("year", c(1:3)) |>
  sdmTMB::replicate_df("age", c(0:7)) |>
  mutate(N = 0, #
         age = as.double(age),
         cell = as.double(cell)) 
```

#### Bind distributions

Bind the expanded distribution datasets to create a distribution dataset that extends the full NEUS shelf area for the survey.
```{r}
full_dist <- bind_rows(no_dist, dist) #|>
  # filter(year ==1, age == 0) |>
  # ggplot() +
  # geom_tile(aes(x,y, fill = N), width = 10, height = 10)
```


## Append abundance object

Add the grid objects and the full distributed numbers at age to the simulated abundance object, the result of which will be called in sim_survey(). 

### The grid 
```{r append grid, include = FALSE}
# append  to abundance and rename list item
pop[[10]] <- grid_stars # use stars object of  grid
names(pop)[[10]] <- "grid"

# resave dataframe grid to match make_grid() output
# grid_xy <- grid |>
#   # dplyr::select(X, Y, depth, division, strat) |>
#   #rename(x = X, y = Y) |>
#   data.table::as.data.table()
#mutate(cell = seq(1:length(depth)))

# append to the simulated abundance object
pop <- append(pop, list(grid_xy))
names(pop)[[11]] <- "grid_xy"

```


### Summer flounder distribution
```{r}
# append to the simulated abundance object
pop <- append(pop, list(full_dist))
names(pop)[[12]] <- "sp_N"


# plot numbers at age
ggplot(pop$sp_N) +
  geom_tile(aes(x, y, fill = N), width = 10, height = 10) +
  scale_fill_viridis_c(trans = "sqrt") +
  facet_wrap(~age, scales = "free_y") +
  labs(x = "Longitude", y = "Latitude", fill = "Number of Summer Flounder") +
  theme_bw() +
  theme(legend.position = "bottom", legend.text = element_text(angle = 45))

```


```{r, include = FALSE}
### save the data
# saveRDS(pop, here("R", "sumflounder", "data", "sumflounder_dist.rds"))

```

